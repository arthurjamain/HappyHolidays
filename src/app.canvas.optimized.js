var CanvasApp=appBaseClass.extend({views:{container:document.getElementById("container"),content:document.getElementById("content"),contentcopy:document.getElementById("contentcopy"),instructions:document.getElementById("instructions"),cover:document.getElementById("cover"),inShad:document.getElementById("insideshadow"),canvas:null},triangleWidth:20,fadeOutThreshold:15,initialize:function(){var a=this;window.app=this;this.totalTriangles=0;this.deletedTriangles=0;if(isMobile.apple.device){this.fadeOutThreshold=25}if(!isMobile.apple.device&&!isMobile.android.device){this.fadeOutThreshold=35}$(window).on("resize",_.bind(this.onResize,this));this.initializeDom();if(isMobile.android.device||isMobile.apple.device||isMobile.seven_inch){this.setContentScale()}this.setContentBounds();this.fillCanvasWithTiledTriangles();this.waitForImages(["img/cover_large.png","img/inside_shadow.png","img/paper_pattern.png","img/background.png"],function(){$(a.views.container).animate({opacity:1},1000);setTimeout(_.bind(function(){this.triggerCardOpening();setTimeout(_.bind(function(){$(".logo").fadeIn(1000);this.triggerCanvasAnimation()},this),1200)},this),2500)})},triggerCardOpening:function(){if(Modernizr.csstransforms3d){$(this.views.cover).addClass("opened");$(this.views.inShad).addClass("opened");setTimeout(_.bind(function(){$(this.views.inShad).css({opacity:0})},this),520),setTimeout(_.bind(function(){$(this.views.inShad).remove();$(this.views.coverShadow).addClass("opened")},this),650)}else{$(this.views.cover).fadeOut(1000);$(this.views.inShad).fadeOut(1000);$(this.views.coverShadow).hide()}},triggerCanvasAnimation:function(){var a=this;this.fillCanvasWithAnimatedTriangles(function(){this.fadeInSeparateLetters(_.bind(function(){this.deletingToggler=0;this.showInstructionPicto();var b=function(d){var c=a.views.canvas.getContext("2d");c.drawImage(a.backgroundPattern,0,0);if(a.instructionsLoop){clearInterval(a.instructionsLoop);$(a.views.instructions).fadeOut(500)}a.paintOverAnimatedTriangles();$(a.views.content).show();$(document).on("mousemove touchmove","canvas",_.bind(a.deleteTriangleUnderCursor,a));if(isMobile.android.device){a.safeEndTimeout=setTimeout(function(){$("#contentcopy").css({opacity:0,display:"block"});$("#contentcopy").animate({opacity:"1"},1000);$(document).off("mousemove touchmove")},5000)}d.preventDefault();return false};$(document).one("mousemove touchstart touchmove","canvas",b)},this));window.theapp=this})},initializeDom:function(){$("#fake-canvas").remove();this.views.content.className+=" big";this.views.contentcopy.className+=" big";this.views.canvasContainer=document.createElement("div");this.views.canvasContainer.className="canvasContainer";this.views.canvas=document.createElement("canvas");this.views.canvas.appendChild(document.createTextNode("This should not happen ..."));this.views.canvasBackground=document.createElement("div");this.views.canvasBackground.className="canvasBackground";this.views.coverShadow=document.createElement("div");this.views.coverShadow.className="covershadow";this.views.canvasContainer.appendChild(this.views.canvasBackground);this.views.canvasContainer.appendChild(this.views.canvas);$(this.views.container).prepend(this.views.coverShadow);$(this.views.container).prepend(this.views.canvasContainer);this.views.canvasContainer.appendChild(this.views.content);if(document.all){$(this.views.cover).addClass("small")}},setContentBounds:function(){var d=parseInt($(this.views.canvasContainer).height(),10);var b=parseInt($(this.views.canvasContainer).width(),10);var a=parseInt($(this.views.coverShadow).width(),10);if(!this.scale){this.scale=1}if(isMobile.apple.device){var f=($(window).width()-b)/2,c=($(window).height()-d)/2}else{var f=($(window).width()-b*this.scale)/2,c=($(window).height()-d*this.scale)/2}f=f-f%this.triangleWidth;c=c-c%this.triangleWidth;var e=parseInt(b-$(this.views.content).width(),10)/2;this.views.contentcopy.style.left=(f+e)+"px";this.views.contentcopy.style.top=(c+e)+"px";this.views.canvasContainer.style.left=(f)+"px";this.views.canvasContainer.style.top=(c)+"px";this.views.coverShadow.style.bottom=($(document).height()-c)+"px";this.views.coverShadow.style.left=(f-(b-a)/2*-1)+"px";this.views.canvas.style.left=e+"px";this.views.canvas.style.top=e+"px";this.views.canvasBackground.style.left=e+"px";this.views.canvasBackground.style.top=e+"px";this.views.canvasBackground.style.width=(b-e*2)+"px";this.views.canvasBackground.style.height=(b-e*2)+"px";this.views.inShad.style.left=(f-5)+"px";this.views.inShad.style.top=(c-5)+"px";this.views.cover.style.width=(b)+"px";this.views.cover.style.height=(d)+"px";this.views.cover.style.left=(f)+"px";this.views.cover.style.top=(c)+"px";if(this.views.canvas.width!==b){this.views.canvas.width=(b-e*2)}if(this.views.canvas.height!==b){this.views.canvas.height=(d-e*2)}this.views.instructions.style.left=(f+b/2-$(this.views.instructions).width()/2)+"px";this.views.instructions.style.top=(c+d-150)+"px"},deleteTriangleUnderCursor:function(c){c.preventDefault();var a=this;off=$("canvas").offset();var b={x:Math.round((this.getX(c)-off.left)/a.triangleWidth)*a.triangleWidth*(1/this.scale||1),y:Math.round((this.getY(c)-off.top)/a.triangleWidth)*a.triangleWidth*(1/this.scale||1)};if(this.deletingToggler){this.deletingToggler=0;a.clearLargeTriangle(b.x,b.y,false);a.deletedTriangles+=4}else{this.deletingToggler=1;a.clearLargeTriangle(b.x,b.y,true);a.deletedTriangles+=4}if(a.deletedTriangles>=(this.totalTriangles/100*this.fadeOutThreshold)){$("#contentcopy").css({opacity:0,display:"block"});$("#contentcopy").animate({opacity:"1"},1000);if(a.safeEndTimeout){clearTimeout(a.safeEndTimeout)}$(document).off("mousemove touchmove")}if(isMobile.android.device){this.onResize(null,true)}return false},getX:function(a){if(a.pageX){return a.pageX}if(a.originalEvent){if(a.originalEvent.pageX){return a.originalEvent.pageX}if(a.originalEvent.touches&&a.originalEvent.touches.length){if(a.originalEvent.touches[0].pageX){return a.originalEvent.touches[0].pageX}}if(a.originalEvent.x){return a.originalEvent.x}}},getY:function(a){if(a.pageY){return a.pageY}if(a.originalEvent){if(a.originalEvent.pageY){return a.originalEvent.pageY}if(a.originalEvent.touches&&a.originalEvent.touches.length){if(a.originalEvent.touches[0].pageY){return a.originalEvent.touches[0].pageY}}if(a.originalEvent.y){return a.originalEvent.y}}},paintOverAnimatedTriangles:function(){var a=this.views.canvas.getContext("2d");var b=this;for(var d in this.animatedTriangles){var c=this.animatedTriangles[d],e=this.hexToRgb(this.getColor());var a=this.views.canvas.getContext("2d");if(c.reverted){a.fillStyle="rgba("+e.r+", "+e.g+", "+e.b+", 1)";a.beginPath();a.moveTo(c.x+this.triangleWidth,c.y+this.triangleWidth);a.lineTo(c.x+this.triangleWidth,c.y);a.lineTo(c.x,c.y+this.triangleWidth);a.fill()}else{a.fillStyle="rgba("+e.r+", "+e.g+", "+e.b+", 1)";a.beginPath();a.moveTo(c.x,c.y);a.lineTo(c.x+this.triangleWidth+4,c.y);a.lineTo(c.x,c.y+this.triangleWidth+4);a.fill()}}},fillCanvasWithAnimatedTriangles:function(a){var b=this.views.canvas.getContext("2d");var c=this;for(var e in this.animatedTriangles){var d=this.animatedTriangles[e];d.x+=60;d.y+=200;setTimeout(_.bind(function(){c.fadeInTriangle(this.t.x,this.t.y,150,this.t.reverted);setTimeout(_.bind(function(){c.fadeOutTriangle(this.t.x,this.t.y,175,this.t.reverted);if(this.i==c.animatedTriangles.length-1){setTimeout(function(){if(typeof a==="function"){a.call(c)}},150)}},{t:this.t,i:this.i}),600)},{t:d,i:e}),e*30)}},fadeInSeparateLetters:function(a){var b=this;for(var c in this.digits){setTimeout(_.bind(function(){var d=0;for(var e=b.digits[this.i].startIndex;e<b.digits[this.i].startIndex+b.digits[this.i].span;e++){setTimeout(_.bind(function(){if(b.animatedTriangles[this.j]){b.fadeInTriangle(b.animatedTriangles[this.j].x,b.animatedTriangles[this.j].y,150,b.animatedTriangles[this.j].reverted)}if(this.i==b.digits.length-1&&this.j==b.digits[this.i].startIndex+b.digits[this.i].span-1){setTimeout(function(){if(typeof a==="function"){a()}},150)}},{i:this.i,j:e}),40*d);d++}},{i:c}),150*c)}},clearLargeTriangle:function(a,d,c){var b=this.views.canvas.getContext("2d");if(document.all){b.clearRect(a,d,this.triangleWidth,this.triangleWidth);return}if(c){b.beginPath();b.moveTo(a,d);b.lineTo(a+this.triangleWidth*2,d);b.lineTo(a,d+this.triangleWidth*2);b.save();b.clip();b.clearRect(a,d,a+this.triangleWidth*2,d+this.triangleWidth*2);b.restore()}else{b.beginPath();b.moveTo(a+40,d);b.lineTo(a+this.triangleWidth*2,d+40);b.lineTo(a,d+this.triangleWidth*2);b.save();b.clip();b.clearRect(0,0,700,300);b.restore()}},fadeInTriangle:function(h,g,a,f,b){f=f||false;var k=this.views.canvas.getContext("2d"),j=Math.ceil(a/17),e=0,d=0;var c=setInterval(_.bind(function(){e++;d+=1/j;if(!f){k.beginPath();k.moveTo(h,g);k.lineTo(h+this.triangleWidth,g);k.lineTo(h,g+this.triangleWidth);if(true){k.clearRect(h,g,this.triangleWidth,this.triangleWidth)}else{k.save();k.clip();k.clearRect(h,g,h+this.triangleWidth,g+this.triangleWidth);k.restore()}k.fillStyle="rgba(255, 255, 255, "+(d)+")";k.beginPath();k.moveTo(h,g);k.lineTo(h+this.triangleWidth+1,g);k.lineTo(h,g+this.triangleWidth+1);k.fill()}else{k.beginPath();k.moveTo(h+this.triangleWidth,g+this.triangleWidth);k.lineTo(h+this.triangleWidth,g+1);k.lineTo(h+1,g+this.triangleWidth);if(true){k.clearRect(h,g,this.triangleWidth,this.triangleWidth)}else{k.save();k.clip();k.clearRect(h,g,h+this.triangleWidth,g+this.triangleWidth);k.restore()}k.fillStyle="rgba(255, 255, 255, "+(d)+")";k.beginPath();k.moveTo(h+this.triangleWidth,g+this.triangleWidth);k.lineTo(h+this.triangleWidth,g);k.lineTo(h,g+this.triangleWidth);k.fill()}if(e==j){clearInterval(c)}},this),17)},fadeOutTriangle:function(h,g,a,f,b){f=f||false;var k=this.views.canvas.getContext("2d"),j=Math.ceil(a/17),e=j,d=1;var c=setInterval(_.bind(function(){e--;d=d-1/j;d=d<0?0:d;if(!f){k.beginPath();k.moveTo(h,g);k.lineTo(h+this.triangleWidth+2,g);k.lineTo(h,g+this.triangleWidth+2);if(true){k.clearRect(h,g,this.triangleWidth,this.triangleWidth)}else{k.save();k.clip();k.clearRect(h,g,h+this.triangleWidth,g+this.triangleWidth);k.restore()}k.fillStyle="rgba(255, 255, 255, "+d+")";k.beginPath();k.moveTo(h,g);k.lineTo(h+this.triangleWidth,g);k.lineTo(h,g+this.triangleWidth);k.fill()}else{k.beginPath();k.moveTo(h+this.triangleWidth,g+this.triangleWidth);k.lineTo(h+this.triangleWidth,g);k.lineTo(h,g+this.triangleWidth);if(true){k.clearRect(h,g,this.triangleWidth,this.triangleWidth)}else{k.save();k.clip();k.clearRect(h,g,h+this.triangleWidth,g+this.triangleWidth);k.restore()}k.fillStyle="rgba(255, 255, 255, "+d+")";k.beginPath();k.moveTo(h+this.triangleWidth,g+this.triangleWidth);k.lineTo(h+this.triangleWidth,g);k.lineTo(h,g+this.triangleWidth);k.fill()}if(e===0){clearInterval(c)}},this),17)},fillCanvasWithTiledTriangles:function(){var b=this.views.canvas.width;var d=this.views.canvas.height;var e;var a=this.views.canvas.getContext("2d");this.backgroundPattern=new Image();var c=function(f){a.drawImage(this.backgroundPattern,0,0)};this.backgroundPattern.onLoad=_.bind(c,this);this.backgroundPattern.onload=_.bind(c,this);this.backgroundPattern.src="img/background.png";this.totalTriangles=b/(this.triangleWidth/2)*d/this.triangleWidth;return},drawTiledTriangle:function(a,e,c,d){var b=this.views.canvas.getContext("2d");if(c){b.fillStyle="rgba("+d.r+", "+d.g+", "+d.b+", 1)";b.beginPath();b.moveTo(a+this.triangleWidth,e+this.triangleWidth);b.lineTo(a+this.triangleWidth,e);b.lineTo(a,e+this.triangleWidth);b.fill()}else{b.fillStyle="rgba("+d.r+", "+d.g+", "+d.b+", 1)";b.beginPath();b.moveTo(a,e);b.lineTo(a+this.triangleWidth+1,e);b.lineTo(a,e+this.triangleWidth+1);b.fill()}},onResize:function(h,f){var d=parseInt($(this.views.canvasContainer).height(),10);var b=parseInt($(this.views.canvasContainer).width(),10);var a=parseInt($(this.views.coverShadow).width(),10);var i,c;if(isMobile.apple.device){i=($(window).width()-b)/2;c=($(window).height()-d)/2}else{i=($(window).width()-b*this.scale)/2;c=($(window).height()-d*this.scale)/2}i=i-i%this.triangleWidth;c=c-c%this.triangleWidth;var g=parseInt(b-$(this.views.content).width(),10)/2;if(f){this.forceResizeOffset=this.forceResizeOffset*-1||1}this.views.canvas.style.left=(g+(this.forceResizeOffset||0))+"px";this.views.canvas.style.top=(g+(this.forceResizeOffset*-1||0))+"px";this.views.contentcopy.style.left=(i+g)+"px";this.views.contentcopy.style.top=(c+g)+"px";this.views.canvasContainer.style.left=(i)+"px";this.views.canvasContainer.style.top=(c)+"px";this.views.coverShadow.style.bottom=$(window).height()-c-3+"px";this.views.coverShadow.style.left=i-(b-a)/2*-1+"px";this.views.instructions.style.left=(i+b/2-$(this.views.instructions).width()/2)+"px";this.views.instructions.style.top=c+d-150+"px";this.views.inShad.style.left=(i-5)+"px";this.views.inShad.style.top=(c-5)+"px";this.views.cover.style.left=(i)+"px";this.views.cover.style.top=(c)+"px";if(isMobile.android.device||isMobile.apple.device||isMobile.seven_inch){if($(window).height()!==(this.prevWindowHeight||0)){this.setContentScale();this.prevWindowHeight=$(window).height()}}},getColor:function(){var b=0,d=0;for(var c in this.colors){b+=this.colors[c][1]}var e=Math.floor(Math.random()*b);for(var a in this.colors){d+=this.colors[a][1];if(e<d){return this.colors[a][0]}}},hexToRgb:function(b){var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(b);return a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null}});